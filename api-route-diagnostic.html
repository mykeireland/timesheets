<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Route Diagnostic</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #333; }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      font-weight: 500;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .results {
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    .status-ok { color: #28a745; font-weight: bold; }
    .status-error { color: #dc3545; font-weight: bold; }
    .route-test {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #007bff;
    }
    .loading { opacity: 0.6; }
  </style>
</head>
<body>
  <h1>üîç API Route Diagnostic Tool</h1>
  <p><strong>API Base URL:</strong> <code id="apiBase"></code></p>

  <div class="test-section">
    <h2>Test Admin Routes</h2>
    <p>Testing various possible route patterns for admin endpoints:</p>
    <button onclick="testAllAdminRoutes()">Test All Admin Routes</button>
    <button onclick="testResetPinRoutes()">Test Reset PIN Routes</button>
    <button onclick="testPinStatusRoutes()">Test PIN Status Routes</button>
    <div id="adminResults" class="results"></div>
  </div>

  <div class="test-section">
    <h2>Test Known Working Routes</h2>
    <button onclick="testWorkingRoutes()">Test Working Endpoints</button>
    <div id="workingResults" class="results"></div>
  </div>

  <div class="test-section">
    <h2>Azure Functions List</h2>
    <p>If functions are deployed, Azure typically provides a list endpoint:</p>
    <button onclick="testFunctionsList()">Try to List Functions</button>
    <div id="functionsResults" class="results"></div>
  </div>

  <script>
    const API_BASE = window.API_BASE;
    document.getElementById('apiBase').textContent = API_BASE;

    async function testRoute(routePath, method = 'GET', body = null, description = '') {
      const url = `${API_BASE}${routePath}`;
      const resultDiv = document.createElement('div');
      resultDiv.className = 'route-test loading';
      resultDiv.innerHTML = `
        <div><strong>${description || routePath}</strong></div>
        <div>Testing: <code>${url}</code></div>
        <div>Method: ${method}</div>
        <div>Status: Testing...</div>
      `;

      return new Promise(async (resolve) => {
        try {
          const options = {
            method,
            headers: { 'Content-Type': 'application/json' }
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          const startTime = Date.now();
          const response = await fetch(url, options);
          const duration = Date.now() - startTime;

          let responseText = '';
          let responseData = null;

          try {
            responseText = await response.text();
            responseData = JSON.parse(responseText);
          } catch {
            // Response wasn't JSON
          }

          const statusClass = response.ok ? 'status-ok' : 'status-error';

          resultDiv.className = 'route-test';
          resultDiv.innerHTML = `
            <div><strong>${description || routePath}</strong></div>
            <div>URL: <code>${url}</code></div>
            <div>Method: ${method}</div>
            <div class="${statusClass}">Status: ${response.status} ${response.statusText} (${duration}ms)</div>
            ${responseData ? `<div>Response: <pre>${JSON.stringify(responseData, null, 2)}</pre></div>` : ''}
            ${!response.ok && responseText ? `<div>Error: ${responseText.substring(0, 200)}</div>` : ''}
          `;

          resolve({ url, status: response.status, ok: response.ok, data: responseData });
        } catch (err) {
          resultDiv.className = 'route-test';
          resultDiv.innerHTML = `
            <div><strong>${description || routePath}</strong></div>
            <div>URL: <code>${url}</code></div>
            <div>Method: ${method}</div>
            <div class="status-error">Error: ${err.message}</div>
          `;
          resolve({ url, error: err.message });
        }
      });
    }

    async function testAllAdminRoutes() {
      const resultsDiv = document.getElementById('adminResults');
      resultsDiv.innerHTML = '<p>Testing all possible admin route patterns...</p>';

      const routes = [
        // Current routes that return 404
        { path: '/admin/pin-status', method: 'GET', desc: 'Current: GET /admin/pin-status' },
        { path: '/admin/reset-pin', method: 'POST', body: {employeeId: "1", newPin: "0000"}, desc: 'Current: POST /admin/reset-pin' },

        // Alternative patterns
        { path: '/pin-status', method: 'GET', desc: 'Alternative: GET /pin-status (no admin prefix)' },
        { path: '/reset-pin', method: 'POST', body: {employeeId: "1", newPin: "0000"}, desc: 'Alternative: POST /reset-pin (no admin prefix)' },

        { path: '/auth/pin-status', method: 'GET', desc: 'Alternative: GET /auth/pin-status' },
        { path: '/auth/reset-pin', method: 'POST', body: {employeeId: "1", newPin: "0000"}, desc: 'Alternative: POST /auth/reset-pin' },

        { path: '/admin/getPinStatus', method: 'GET', desc: 'PascalCase: GET /admin/getPinStatus' },
        { path: '/admin/resetPin', method: 'POST', body: {employeeId: "1", newPin: "0000"}, desc: 'camelCase: POST /admin/resetPin' },

        { path: '/Admin/pin-status', method: 'GET', desc: 'Capitalized: GET /Admin/pin-status' },
        { path: '/Admin/reset-pin', method: 'POST', body: {employeeId: "1", newPin: "0000"}, desc: 'Capitalized: POST /Admin/reset-pin' },
      ];

      for (const route of routes) {
        const result = await testRoute(route.path, route.method, route.body, route.desc);
        const div = document.querySelector('.route-test:last-child');
        if (div) resultsDiv.appendChild(div);

        // Add small delay to avoid rate limiting
        await new Promise(r => setTimeout(r, 100));
      }
    }

    async function testResetPinRoutes() {
      const resultsDiv = document.getElementById('adminResults');
      resultsDiv.innerHTML = '<p>Testing Reset PIN route variations...</p>';

      const testBody = { employeeId: "1", newPin: "0000" };

      const routes = [
        '/admin/reset-pin',
        '/reset-pin',
        '/auth/reset-pin',
        '/admin/resetPin',
        '/resetPin',
        '/Admin/reset-pin',
        '/ResetPin'
      ];

      for (const path of routes) {
        await testRoute(path, 'POST', testBody, `POST ${path}`);
        const div = document.querySelector('.route-test:last-child');
        if (div) resultsDiv.appendChild(div);
        await new Promise(r => setTimeout(r, 100));
      }
    }

    async function testPinStatusRoutes() {
      const resultsDiv = document.getElementById('adminResults');
      resultsDiv.innerHTML = '<p>Testing PIN Status route variations...</p>';

      const routes = [
        '/admin/pin-status',
        '/pin-status',
        '/auth/pin-status',
        '/admin/pinStatus',
        '/pinStatus',
        '/Admin/pin-status',
        '/PinStatus',
        '/admin/getPinStatus',
        '/GetPinStatus'
      ];

      for (const path of routes) {
        await testRoute(path, 'GET', null, `GET ${path}`);
        const div = document.querySelector('.route-test:last-child');
        if (div) resultsDiv.appendChild(div);
        await new Promise(r => setTimeout(r, 100));
      }
    }

    async function testWorkingRoutes() {
      const resultsDiv = document.getElementById('workingResults');
      resultsDiv.innerHTML = '<p>Testing known working endpoints...</p>';

      const routes = [
        { path: '/employees', method: 'GET', desc: 'GET /employees (known working)' },
        { path: '/auth/verify-pin', method: 'POST', body: {employeeId: 1, pin: "9999"}, desc: 'POST /auth/verify-pin (should fail with invalid PIN)' }
      ];

      for (const route of routes) {
        await testRoute(route.path, route.method, route.body, route.desc);
        const div = document.querySelector('.route-test:last-child');
        if (div) resultsDiv.appendChild(div);
        await new Promise(r => setTimeout(r, 100));
      }
    }

    async function testFunctionsList() {
      const resultsDiv = document.getElementById('functionsResults');
      resultsDiv.innerHTML = '<p>Attempting to discover Azure Functions...</p>';

      // Try various discovery endpoints
      const discoveryRoutes = [
        '/',
        '/admin/functions',
        '/api',
        '/.well-known',
        '/health',
        '/status'
      ];

      for (const path of discoveryRoutes) {
        await testRoute(path, 'GET', null, `Discovery: GET ${path}`);
        const div = document.querySelector('.route-test:last-child');
        if (div) resultsDiv.appendChild(div);
        await new Promise(r => setTimeout(r, 100));
      }
    }
  </script>
</body>
</html>
