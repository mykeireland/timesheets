<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIN Functions Diagnostic Report</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    h1 { color: #333; margin-bottom: 10px; }
    .subtitle { color: #666; margin-bottom: 30px; }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-box {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: bold;
      margin: 5px 0;
    }
    .status-working { background: #d4edda; color: #155724; }
    .status-broken { background: #f8d7da; color: #721c24; }
    .status-unknown { background: #fff3cd; color: #856404; }
    button {
      padding: 12px 24px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      font-weight: 500;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .test-result {
      margin: 15px 0;
      padding: 15px;
      border-left: 4px solid #007bff;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .test-result.success { border-left-color: #28a745; background: #d4edda; }
    .test-result.error { border-left-color: #dc3545; background: #f8d7da; }
    .test-result.info { border-left-color: #17a2b8; background: #d1ecf1; }
    .code-block {
      background: #272822;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 10px 0;
    }
    .recommendation {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .recommendation h3 {
      margin-top: 0;
      color: #856404;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    tr:hover { background: #f8f9fa; }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-success { background: #28a745; color: white; }
    .badge-danger { background: #dc3545; color: white; }
    .badge-warning { background: #ffc107; color: #333; }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loading.active {
      display: block;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>üîç PIN Functions Diagnostic Report</h1>
  <p class="subtitle">Comprehensive analysis of GetPinStatus and ResetPin 404 errors</p>

  <div class="section">
    <h2>üìä Current Status</h2>
    <div>
      <strong>API Base URL:</strong> <code id="apiBaseUrl"></code>
    </div>
    <div style="margin-top: 15px;">
      <strong>Function Key Configured:</strong> <span id="functionKeyStatus"></span>
    </div>
    <div style="margin-top: 20px;">
      <button onclick="runFullDiagnostic()">üöÄ Run Full Diagnostic</button>
      <button onclick="testWithFunctionKey()">üîë Test with Function Key</button>
      <button onclick="copyReport()">üìã Copy Report to Clipboard</button>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Running diagnostic tests...</p>
  </div>

  <div id="results" style="display: none;">

    <div class="section">
      <h2>üéØ Test Results Summary</h2>
      <table id="summaryTable">
        <thead>
          <tr>
            <th>Endpoint</th>
            <th>Expected Route</th>
            <th>Method</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>üî¨ Detailed Test Results</h2>
      <div id="detailedResults"></div>
    </div>

    <div class="section">
      <h2>üí° Diagnosis & Recommendations</h2>
      <div id="recommendations"></div>
    </div>

    <div class="section">
      <h2>üìù Next Steps</h2>
      <div id="nextSteps"></div>
    </div>

  </div>

  <script>
    const API_BASE = window.API_BASE;
    const ADMIN_KEY = window.ADMIN_FUNCTION_KEY;

    document.getElementById('apiBaseUrl').textContent = API_BASE;
    document.getElementById('functionKeyStatus').innerHTML = ADMIN_KEY
      ? '<span class="badge badge-success">Yes - Key is set</span>'
      : '<span class="badge badge-warning">No - Key is empty</span>';

    let diagnosticResults = {
      verifyPin: null,
      getPinStatus: null,
      resetPin: null,
      alternatives: []
    };

    async function testEndpoint(path, method = 'GET', body = null, useKey = false) {
      let url = `${API_BASE}${path}`;
      if (useKey && ADMIN_KEY) {
        url += `?code=${ADMIN_KEY}`;
      }

      const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      const startTime = Date.now();
      try {
        const response = await fetch(url);
        const duration = Date.now() - startTime;

        let data = null;
        let responseText = '';
        const contentType = response.headers.get('content-type');

        try {
          responseText = await response.text();
          if (contentType && contentType.includes('application/json')) {
            data = JSON.parse(responseText);
          }
        } catch (e) {
          // Not JSON
        }

        return {
          url,
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          duration,
          data,
          responseText: responseText.substring(0, 500),
          contentType
        };
      } catch (error) {
        return {
          url,
          status: 0,
          statusText: 'Network Error',
          ok: false,
          duration: Date.now() - startTime,
          error: error.message
        };
      }
    }

    async function runFullDiagnostic() {
      document.getElementById('loading').classList.add('active');
      document.getElementById('results').style.display = 'none';

      // Test 1: Verify Pin (known working)
      console.log('Testing VerifyPin...');
      diagnosticResults.verifyPin = await testEndpoint('/auth/verify-pin', 'POST', {
        employeeId: 999,
        pin: '9999'
      });

      // Test 2: GetPinStatus (current route)
      console.log('Testing GetPinStatus...');
      diagnosticResults.getPinStatus = await testEndpoint('/admin/pin-status', 'GET');

      // Test 3: ResetPin (current route)
      console.log('Testing ResetPin...');
      diagnosticResults.resetPin = await testEndpoint('/admin/reset-pin', 'POST', {
        employeeId: '1',
        newPin: '0000'
      });

      // Test alternative routes
      console.log('Testing alternative routes...');
      const alternatives = [
        { path: '/pin-status', method: 'GET', desc: 'GetPinStatus without /admin prefix' },
        { path: '/reset-pin', method: 'POST', body: { employeeId: '1', newPin: '0000' }, desc: 'ResetPin without /admin prefix' },
        { path: '/auth/pin-status', method: 'GET', desc: 'GetPinStatus under /auth' },
        { path: '/auth/reset-pin', method: 'POST', body: { employeeId: '1', newPin: '0000' }, desc: 'ResetPin under /auth' },
        { path: '/admin/getPinStatus', method: 'GET', desc: 'GetPinStatus camelCase' },
        { path: '/admin/resetPin', method: 'POST', body: { employeeId: '1', newPin: '0000' }, desc: 'ResetPin camelCase' },
      ];

      for (const alt of alternatives) {
        const result = await testEndpoint(alt.path, alt.method, alt.body);
        diagnosticResults.alternatives.push({ ...alt, result });
        await new Promise(r => setTimeout(r, 100)); // Rate limiting
      }

      document.getElementById('loading').classList.remove('active');
      displayResults();
    }

    async function testWithFunctionKey() {
      if (!ADMIN_KEY) {
        alert('No function key configured in config.js. Please add your function key first.');
        return;
      }

      document.getElementById('loading').classList.add('active');

      // Test with function key
      const pinStatusWithKey = await testEndpoint('/admin/pin-status', 'GET', null, true);
      const resetPinWithKey = await testEndpoint('/admin/reset-pin', 'POST', {
        employeeId: '1',
        newPin: '0000'
      }, true);

      alert(`Results with function key:\n\n` +
            `GetPinStatus: ${pinStatusWithKey.status} ${pinStatusWithKey.statusText}\n` +
            `ResetPin: ${resetPinWithKey.status} ${resetPinWithKey.statusText}\n\n` +
            `Check the detailed results below for more information.`);

      document.getElementById('loading').classList.remove('active');
    }

    function displayResults() {
      document.getElementById('results').style.display = 'block';

      // Summary table
      const summaryBody = document.getElementById('summaryBody');
      summaryBody.innerHTML = '';

      const endpoints = [
        { name: 'VerifyPin', route: '/auth/verify-pin', method: 'POST', result: diagnosticResults.verifyPin },
        { name: 'GetPinStatus', route: '/admin/pin-status', method: 'GET', result: diagnosticResults.getPinStatus },
        { name: 'ResetPin', route: '/admin/reset-pin', method: 'POST', result: diagnosticResults.resetPin }
      ];

      endpoints.forEach(ep => {
        const row = summaryBody.insertRow();
        row.innerHTML = `
          <td><strong>${ep.name}</strong></td>
          <td><code>${ep.route}</code></td>
          <td>${ep.method}</td>
          <td><span class="badge ${ep.result.ok ? 'badge-success' : 'badge-danger'}">${ep.result.status} ${ep.result.statusText}</span></td>
          <td>${ep.result.ok ? '‚úÖ Working' : '‚ùå ' + (ep.result.status === 404 ? 'Not Found' : 'Error')}</td>
        `;
      });

      // Detailed results
      const detailedDiv = document.getElementById('detailedResults');
      detailedDiv.innerHTML = '';

      endpoints.forEach(ep => {
        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${ep.result.ok ? 'success' : 'error'}`;
        resultDiv.innerHTML = `
          <h3>${ep.name} - ${ep.method} ${ep.route}</h3>
          <p><strong>URL:</strong> <code>${ep.result.url}</code></p>
          <p><strong>Status:</strong> ${ep.result.status} ${ep.result.statusText} (${ep.result.duration}ms)</p>
          ${ep.result.data ? `<p><strong>Response:</strong> <pre>${JSON.stringify(ep.result.data, null, 2)}</pre></p>` : ''}
          ${ep.result.error ? `<p><strong>Error:</strong> ${ep.result.error}</p>` : ''}
        `;
        detailedDiv.appendChild(resultDiv);
      });

      // Recommendations
      generateRecommendations();

      // Next steps
      generateNextSteps();
    }

    function generateRecommendations() {
      const recsDiv = document.getElementById('recommendations');
      recsDiv.innerHTML = '';

      const { verifyPin, getPinStatus, resetPin, alternatives } = diagnosticResults;

      // Check if working alternatives found
      const workingAlts = alternatives.filter(alt => alt.result.ok || (alt.result.status !== 404 && alt.result.status !== 0));

      if (getPinStatus.status === 404 && resetPin.status === 404) {
        if (workingAlts.length > 0) {
          // Found working alternative routes
          const rec = document.createElement('div');
          rec.className = 'recommendation';
          rec.innerHTML = `
            <h3>‚úÖ Found Working Alternative Routes!</h3>
            <p>The expected routes return 404, but these alternatives work:</p>
            <ul>
              ${workingAlts.map(alt => `<li><strong>${alt.desc}</strong>: ${alt.result.status} ${alt.result.statusText}</li>`).join('')}
            </ul>
            <p><strong>Recommendation:</strong> Update your frontend code to use these working routes.</p>
          `;
          recsDiv.appendChild(rec);
        } else if (getPinStatus.status === 401 || resetPin.status === 401) {
          // 401 means function exists but needs auth
          const rec = document.createElement('div');
          rec.className = 'recommendation';
          rec.innerHTML = `
            <h3>üîë Functions Exist But Need Authorization</h3>
            <p>The endpoints are deployed but require a function key (HTTP 401 Unauthorized).</p>
            <p><strong>Solution Options:</strong></p>
            <ol>
              <li><strong>Option A (Quick):</strong> Get the function key from Azure Portal and add it to config.js</li>
              <li><strong>Option B (Better):</strong> Change the backend Azure Functions to use AuthorizationLevel.Anonymous</li>
            </ol>
            <div class="code-block">// In Azure Portal:
1. Go to your Function App
2. Click Functions ‚Üí ResetPin (or GetPinStatus)
3. Click "Function Keys"
4. Copy the "default" key value
5. Paste in config.js: window.ADMIN_FUNCTION_KEY = "YOUR_KEY_HERE";</div>
          `;
          recsDiv.appendChild(rec);
        } else {
          // Functions not deployed
          const rec = document.createElement('div');
          rec.className = 'recommendation';
          rec.innerHTML = `
            <h3>‚ùå Functions Not Deployed</h3>
            <p>The GetPinStatus and ResetPin Azure Functions are not deployed or not accessible.</p>
            <p><strong>Evidence:</strong></p>
            <ul>
              <li>VerifyPin works fine (${verifyPin.status})</li>
              <li>GetPinStatus returns 404</li>
              <li>ResetPin returns 404</li>
              <li>No alternative routes work</li>
            </ul>
            <p><strong>Recommendation:</strong> Deploy these Azure Functions to your Function App.</p>
          `;
          recsDiv.appendChild(rec);
        }
      } else if (getPinStatus.ok && resetPin.ok) {
        const rec = document.createElement('div');
        rec.className = 'recommendation';
        rec.innerHTML = `
          <h3>‚úÖ All Functions Working!</h3>
          <p>Both GetPinStatus and ResetPin are working correctly. The 404 issue appears to be resolved.</p>
        `;
        recsDiv.appendChild(rec);
      }
    }

    function generateNextSteps() {
      const stepsDiv = document.getElementById('nextSteps');
      const { getPinStatus, resetPin } = diagnosticResults;

      if (getPinStatus.status === 404 && resetPin.status === 404) {
        stepsDiv.innerHTML = `
          <h3>üîß Action Items</h3>
          <ol>
            <li><strong>Check Azure Portal:</strong>
              <ul>
                <li>Navigate to your Function App: <code>func-timesheetsnet-api-dev</code></li>
                <li>Click "Functions" in the left menu</li>
                <li>Look for "GetPinStatus" and "ResetPin" in the list</li>
                <li>If missing, they need to be deployed</li>
              </ul>
            </li>
            <li><strong>If functions exist in Azure:</strong>
              <ul>
                <li>Click each function name</li>
                <li>Click "Get Function Url" button</li>
                <li>Note the exact route (e.g., /api/admin/reset-pin or /api/reset-pin)</li>
                <li>Check if it requires ?code=KEY_HERE</li>
              </ul>
            </li>
            <li><strong>If routes are different:</strong>
              <ul>
                <li>Update staff.js lines 93, 315, and 421 to match actual routes</li>
                <li>Commit and push changes</li>
              </ul>
            </li>
            <li><strong>If functions are missing:</strong>
              <ul>
                <li>Locate your backend C# project</li>
                <li>Create GetPinStatus.cs and ResetPin.cs (see BACKEND-ROUTES-REFERENCE.md)</li>
                <li>Deploy to Azure using: <code>func azure functionapp publish func-timesheetsnet-api-dev</code></li>
              </ul>
            </li>
          </ol>
        `;
      } else if (getPinStatus.status === 401 || resetPin.status === 401) {
        stepsDiv.innerHTML = `
          <h3>üîë Add Function Key</h3>
          <ol>
            <li>Go to Azure Portal</li>
            <li>Navigate to Function App ‚Üí Functions ‚Üí ResetPin (or GetPinStatus)</li>
            <li>Click "Function Keys" in left menu</li>
            <li>Copy the "default" key value</li>
            <li>Open config.js and update line 18:
              <div class="code-block">window.ADMIN_FUNCTION_KEY = "paste_key_here";</div>
            </li>
            <li>Commit and push changes</li>
            <li>Test again using the "Test with Function Key" button above</li>
          </ol>
        `;
      } else {
        stepsDiv.innerHTML = `
          <h3>‚úÖ System Operational</h3>
          <p>All PIN functions are working. No action required.</p>
          <p>You can now:</p>
          <ul>
            <li>View PIN status for all employees in staff.html</li>
            <li>Reset employee PINs using the "Reset PIN" button</li>
            <li>Add new employees with automatic default PIN setup</li>
          </ul>
        `;
      }
    }

    function copyReport() {
      const report = `
PIN FUNCTIONS DIAGNOSTIC REPORT
================================
Generated: ${new Date().toLocaleString()}
API Base: ${API_BASE}
Function Key Configured: ${ADMIN_KEY ? 'Yes' : 'No'}

TEST RESULTS:
-------------
1. VerifyPin (/auth/verify-pin)
   Status: ${diagnosticResults.verifyPin?.status} ${diagnosticResults.verifyPin?.statusText}
   Result: ${diagnosticResults.verifyPin?.ok ? '‚úÖ Working' : '‚ùå Failed'}

2. GetPinStatus (/admin/pin-status)
   Status: ${diagnosticResults.getPinStatus?.status} ${diagnosticResults.getPinStatus?.statusText}
   Result: ${diagnosticResults.getPinStatus?.ok ? '‚úÖ Working' : '‚ùå Failed'}

3. ResetPin (/admin/reset-pin)
   Status: ${diagnosticResults.resetPin?.status} ${diagnosticResults.resetPin?.statusText}
   Result: ${diagnosticResults.resetPin?.ok ? '‚úÖ Working' : '‚ùå Failed'}

DIAGNOSIS:
----------
${getDiagnosisText()}

NEXT STEPS:
-----------
${getNextStepsText()}
      `.trim();

      navigator.clipboard.writeText(report).then(() => {
        alert('‚úÖ Diagnostic report copied to clipboard!');
      }).catch(() => {
        alert('‚ùå Failed to copy to clipboard. Please copy manually from the console.');
        console.log(report);
      });
    }

    function getDiagnosisText() {
      const { getPinStatus, resetPin } = diagnosticResults;
      if (getPinStatus.status === 404 && resetPin.status === 404) {
        return 'Functions are not deployed or routes are incorrect.';
      } else if (getPinStatus.status === 401 || resetPin.status === 401) {
        return 'Functions exist but require authorization (function key).';
      } else if (getPinStatus.ok && resetPin.ok) {
        return 'All functions are working correctly.';
      }
      return 'Mixed results - some functions work, others do not.';
    }

    function getNextStepsText() {
      const { getPinStatus, resetPin } = diagnosticResults;
      if (getPinStatus.status === 404 && resetPin.status === 404) {
        return '1. Check Azure Portal for deployed functions\n2. Verify route names match expectations\n3. Deploy missing functions if needed';
      } else if (getPinStatus.status === 401 || resetPin.status === 401) {
        return '1. Get function key from Azure Portal\n2. Add key to config.js\n3. Test again';
      }
      return 'No action required - system is operational.';
    }

    // Auto-run diagnostic on load
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        runFullDiagnostic();
      }, 500);
    });
  </script>
</body>
</html>
